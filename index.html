<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="COC计时器，帮助玩家管理建筑升级时间">
    <meta name="keywords" content="部落冲突,COC,计时器,升级,游戏工具">
    <meta name="author" content="COC计时器">

    <!-- PWA相关meta标签 -->
    <meta name="theme-color" content="#409EFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="COC计时器">
    <meta name="msapplication-TileColor" content="#409EFF">
    <meta name="msapplication-tap-highlight" content="no">

    <title>COC计时器</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">

    <!-- 图标链接 -->
    <link rel="icon" href="./assets/img/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" href="./assets/img/apple-touch-icon-180x180.png">


    <!-- 样式文件 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="./assets/css/main.css">

    <style>
        [v-cloak] {
            display: none !important;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
        }

        .version-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #999;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <el-container>
            <el-main>
                <!-- 头部区域 - 优化版本 -->
                <el-card shadow="never"
                    style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <el-row type="flex" justify="space-between" align="middle">
                        <el-col :xs="16" :sm="18" :md="20">
                            <div style="text-align: center;">
                                <h1
                                    style="margin: 0; font-size: 28px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                                    COC计时器</h1>
                                <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.9;">快速查看剩余升级时间</p>
                            </div>
                        </el-col>
                        <el-col :xs="8" :sm="6" :md="4">
                            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px;">
                                <el-tooltip content="快速粘贴" placement="bottom">
                                    <el-button icon="el-icon-document-copy" circle size="medium"
                                        @click="quickPasteAndProcess"
                                        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                                    </el-button>
                                </el-tooltip>
                                <el-tooltip content="使用帮助" placement="bottom">
                                    <el-button icon="el-icon-question" circle size="medium" @click="showHelpDialog"
                                        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                                    </el-button>
                                </el-tooltip>
                                <el-tooltip content="玩家配置" placement="bottom">
                                    <el-button icon="el-icon-setting" circle size="medium" @click="showConfigDialog"
                                        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
                                    </el-button>
                                </el-tooltip>
                            </div>
                        </el-col>
                    </el-row>
                </el-card>

                <!-- 统计信息 - 紧凑布局 -->
                <el-card style="margin-bottom: 20px;">
                    <el-row :gutter="20" type="flex" justify="space-around" align="middle">
                        <el-col :span="6" style="text-align: center;">
                            <div style="color: #909399; font-size: 14px; margin-bottom: 4px;">总玩家数</div>
                            <div style="font-size: 20px; font-weight: bold; color: #409eff;">{{
                                Object.keys(players).length }}</div>
                        </el-col>
                        <el-col :span="6" style="text-align: center;">
                            <div style="color: #909399; font-size: 14px; margin-bottom: 4px;">升级项目</div>
                            <div style="font-size: 20px; font-weight: bold; color: #e6a23c;">{{
                                AllUpgradingItems.length }}</div>
                        </el-col>
                        <el-col :span="12" style="text-align: center;">
                            <div style="color: #909399; font-size: 14px; margin-bottom: 4px;">最近完成时间</div>
                            <div style="font-size: 20px; font-weight: bold; color: #67c23a;">{{ getNextCompletionTime()
                                }}</div>
                        </el-col>
                    </el-row>
                </el-card>

                <!-- 升级项目列表 -->
                <el-card>
                    <div slot="header">所有升级项目</div>
                    <el-empty v-if="AllUpgradingItems.length === 0" description="暂无升级项目">
                        <el-icon name="info"></el-icon>
                    </el-empty>
                    <div v-else>
                        <el-row v-for="item in AllUpgradingItems" :key="item.id" style="margin-bottom: 8px;">
                            <el-card shadow="hover" :body-style="{ padding: '12px 16px' }">
                                <el-row type="flex" justify="space-between" align="middle">
                                    <el-col>
                                        <div style="font-weight: 500; margin-bottom: 4px;">{{ item.displayName }} (Lv{{
                                            item.lvl }})</div>
                                        <div>
                                            <el-tag size="mini" type="info" style="margin-right: 8px;">{{
                                                playerRemarks[item.playerTag] || item.playerTag }}</el-tag>
                                            <el-tag size="mini">{{ item.categoryName }}</el-tag>
                                        </div>
                                    </el-col>
                                    <el-col style="text-align: right;">
                                        <div
                                            :style="{ fontWeight: '500', color: item.remainingTime <= 0 ? '#67c23a' : '#409eff' }">
                                            {{ formatTime(item.remainingTime) }}
                                        </div>
                                    </el-col>
                                </el-row>
                            </el-card>
                        </el-row>
                    </div>
                </el-card>
            </el-main>
        </el-container>

        <!-- 版本信息 -->
        <div class="version-info" id="version-info">
            <p>加载中...</p>
        </div>

        <!-- 帮助对话框 -->
        <el-dialog title="使用帮助" :visible.sync="helpDialogVisible" center>
            <el-row type="flex" justify="center">
                <el-col style="text-align: center; padding: 20px;">
                    <i class="el-icon-info" style="font-size: 48px; color: #409eff; margin-bottom: 16px;"></i>
                    <h3 style="margin: 16px 0; color: #303133;">COC计时器</h3>
                    <p style="margin: 12px 0; color: #606266; line-height: 1.6;">快速查看剩余升级时间！</p>
                    <el-alert title="1. 获取数据的方式" type="warning" :closable="false">
                        <el-image src="./assets/img/setting.png" lazy></el-image>
                    </el-alert>
                </el-col>
            </el-row>
            <span slot="footer" class="dialog-footer">
                <el-button type="primary" @click="helpDialogVisible = false">知道了</el-button>
            </span>
        </el-dialog>



        <!-- 配置对话框 -->
        <el-dialog title="玩家配置" :visible.sync="configDialogVisible" top="5vh">
            <!-- 通知设置 -->
            <el-card style="margin-bottom: 20px;">
                <div slot="header">
                    <i class="el-icon-bell"></i> 通知设置
                </div>
                <el-row :gutter="20" type="flex" align="middle">
                    <el-col :span="16">
                        <div>
                            <div style="font-weight: bold; margin-bottom: 4px;">升级完成通知</div>
                            <div style="font-size: 12px; color: #909399;">
                                当建筑升级完成时发送系统通知提醒
                                <span v-if="notificationPermission === 'denied'" style="color: #f56c6c;">
                                    (权限已拒绝，请在浏览器设置中手动开启)
                                </span>
                                <span v-else-if="!('Notification' in window)" style="color: #f56c6c;">
                                    (当前浏览器不支持通知功能)
                                </span>
                            </div>
                        </div>
                    </el-col>
                    <el-col :span="8" style="text-align: right;">
                        <el-switch v-model="notificationEnabled" @change="toggleNotification"
                            :disabled="notificationPermission === 'denied' || !('Notification' in window)"
                            active-color="#13ce66" inactive-color="#ff4949">
                        </el-switch>
                    </el-col>
                </el-row>
                <el-row v-if="notificationEnabled" style="margin-top: 15px;">
                    <el-col>
                        <el-alert title="通知功能已开启" type="success" :closable="false" show-icon>
                            <div slot="description">
                                • 升级完成前5分钟会收到提醒通知<br>
                                • 升级完成时会收到完成通知<br>
                                • 点击通知可快速回到应用
                            </div>
                        </el-alert>
                    </el-col>
                </el-row>
            </el-card>

            <!-- 玩家管理 -->
            <el-card style="margin-bottom: 20px;">
                <div slot="header">玩家管理</div>
                <el-input v-model="jsonInput" type="textarea" :rows="4" placeholder="请粘贴玩家的JSON数据..."
                    style="margin-bottom: 10px;">
                </el-input>
                <el-row :gutter="10">
                    <el-col :span="8">
                        <el-button type="success" @click="quickPasteAndProcess" icon="el-icon-document-copy"
                            style="width: 100%;">快速粘贴</el-button>
                    </el-col>
                    <el-col :span="8">
                        <el-button type="primary" @click="parseJsonData" :disabled="!jsonInput.trim()"
                            style="width: 100%;">解析数据</el-button>
                    </el-col>
                    <el-col :span="8">
                        <el-button @click="clearInput" style="width: 100%;">清空输入</el-button>
                    </el-col>
                </el-row>
            </el-card>

            <!-- 玩家列表 -->
            <el-card v-if="Object.keys(players).length > 0">
                <div slot="header">玩家列表</div>
                <el-row v-for="(gameData, playerTag) in players" :key="playerTag" style="margin-bottom: 12px;">
                    <el-card shadow="hover" :body-style="{ padding: '15px' }">
                        <el-row :gutter="10" type="flex" align="middle">
                            <el-col :span="8">
                                <el-tag>{{ playerTag }}</el-tag>
                            </el-col>
                            <el-col :span="8">
                                <el-input v-model="playerRemarks[playerTag]" placeholder="添加备注" size="small"></el-input>
                            </el-col>
                            <el-col :span="8" style="text-align: right;">
                                <el-button @click="removePlayer(playerTag)" type="danger" size="mini">删除</el-button>
                            </el-col>
                        </el-row>
                        <el-row style="margin-top: 10px;">
                            <el-col>
                                <div style="font-size: 12px; color: #909399;">
                                    升级项目: {{ getPlayerUpgradingCount(gameData) }} |
                                    数据时间: {{ formatTimestamp(gameData.timestamp) }}
                                </div>
                            </el-col>
                        </el-row>
                    </el-card>
                </el-row>
            </el-card>
            <el-empty v-else description="暂无玩家数据，请先添加玩家">
                <el-icon name="user"></el-icon>
            </el-empty>

            <span slot="footer" class="dialog-footer">
                <el-button @click="configDialogVisible = false">关闭</el-button>
            </span>
        </el-dialog>
    </div>

    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="./assets/data/namemap.js"></script>
    <script src="./assets/js/app.js"></script>
    <script src="./assets/js/pwa.js"></script>
</body>

</html>